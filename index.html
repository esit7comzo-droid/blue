<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>CM-151 BLE Web</title>
</head>
<body>

<h2>CM-151 BLE (Nordic UART)</h2>

<button onclick="connect()">Connect</button>
<button onclick="disconnect()">Disconnect</button>
<button onclick="reconnect()">Reconnect</button>

<br><br>

<input type="text" id="msg" placeholder="Î≥¥ÎÇº Î©îÏãúÏßÄ">
<button onclick="send()">Send</button>

<pre id="log"></pre>

<script>
let device;
let server;
let service;
let txChar; // Ïì∞Í∏∞
let rxChar; // ÏùΩÍ∏∞/notify

const NUS_SERVICE = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const TX_CHAR = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // write
const RX_CHAR = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // notify

function log(text){
  document.getElementById("log").textContent += text + "\n";
}

async function connect() {
  try {
    device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: "CM-151" }],
      optionalServices: [NUS_SERVICE]
    });

    server = await device.gatt.connect();
    service = await server.getPrimaryService(NUS_SERVICE);

    txChar = await service.getCharacteristic(TX_CHAR);
    rxChar = await service.getCharacteristic(RX_CHAR);

    await rxChar.startNotifications();
    rxChar.addEventListener('characteristicvaluechanged', handleRX);

    log("‚úÖ Connected");
  } catch (err) {
    log("‚ùå Connect error: " + err);
  }
}

function handleRX(event) {
  let value = new TextDecoder().decode(event.target.value);
  log("üì• RX: " + value);
}

async function send() {
  try {
    let text = document.getElementById("msg").value;
    let data = new TextEncoder().encode(text);
    await txChar.writeValue(data);
    log("üì§ TX: " + text);
  } catch (err) {
    log("‚ùå Send error: " + err);
  }
}

function disconnect() {
  if (device && device.gatt.connected) {
    device.gatt.disconnect();
    log("üîå Disconnected");
  }
}

async function reconnect() {
  try {
    if (device) {
      if (device.gatt.connected) {
        device.gatt.disconnect();
      }
      server = await device.gatt.connect();
      log("üîÑ Reconnected");
    }
  } catch (err) {
    log("‚ùå Reconnect error: " + err);
  }
}
</script>

</body>
</html>
